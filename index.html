<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <script>
        // Immediate auth check to prevent content flashing
        (function () {
            try {
                const session = localStorage.getItem('sb-session');
                if (!session) {
                    window.location.replace('login.html');
                } else {
                    const parsed = JSON.parse(session);
                    if (!parsed || !parsed.access_token) {
                        window.location.replace('login.html');
                    }
                }
            } catch (e) {
                window.location.replace('login.html');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Repository</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Mammoth.js for DOCX support -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-container">
            <div class="logo-section">
                <h1>Knowledge Repository</h1>
            </div>
            <nav class="main-nav">
                <button class="nav-btn active" data-view="articles">מאמרים</button>
                <button class="nav-btn" data-view="recently-viewed"><i class="fa-solid fa-clock-rotate-left"></i> נצפו
                    לאחרונה</button>
                <button class="nav-btn" data-view="favorites"><i class="fa-solid fa-heart"></i> מועדפים</button>
                <button class="nav-btn" data-view="editor">עורך מאמרים</button>

                <button class="nav-btn" data-view="manage-tags">ניהול תגיות</button>
            </nav>
            <div class="user-section" id="user-section">
                <span id="user-name" style="font-weight: 500;"></span>
                <button onclick="showView('profile')" class="btn-profile" title="פרופיל">
                    <i class="fa-solid fa-user"></i>
                </button>
                <button onclick="logout()" class="btn-logout">
                    <i class="fa-solid fa-right-from-bracket"></i> יציאה
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Articles View -->
        <section id="articles-view" class="view active">
            <div class="articles-header">
                <h2>כל המאמרים</h2>
                <div class="filters-section">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="חיפוש מאמרים...">
                        <span class="search-icon"><i class="fa-solid fa-magnifying-glass"></i></span>
                        <div id="search-autocomplete" class="search-autocomplete"></div>
                    </div>
                    <div class="filter-dropdowns">
                        <div class="dropdown-group">
                            <label for="filter-category">קטגוריה:</label>
                            <select id="filter-category">
                                <option value="">הכל</option>
                            </select>
                        </div>
                        <div class="dropdown-group">
                            <label for="filter-department">מחלקה:</label>
                            <select id="filter-department">
                                <option value="">הכל</option>
                            </select>
                        </div>
                        <div class="dropdown-group">
                            <label for="filter-priority">עדיפות:</label>
                            <select id="filter-priority">
                                <option value="">הכל</option>
                            </select>
                        </div>
                        <div class="dropdown-group">
                            <label for="sort-articles">מיון לפי:</label>
                            <select id="sort-articles">
                                <option value="date-desc">תאריך (חדש לישן)</option>
                                <option value="date-asc">תאריך (ישן לחדש)</option>
                                <option value="title-asc">שם (א-ת)</option>
                                <option value="title-desc">שם (ת-א)</option>
                                <option value="priority">עדיפות</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="articles-list" class="articles-grid">
                <!-- Articles will be loaded here -->
            </div>
        </section>

        <!-- Favorites View -->
        <section id="favorites-view" class="view">
            <div class="articles-header">
                <h2><i class="fa-solid fa-heart"></i> המאמרים המועדפים שלי</h2>
            </div>
            <div id="favorites-list" class="articles-grid">
                <!-- Favorite articles will be loaded here -->
            </div>
        </section>

        <!-- Recently Viewed View -->
        <section id="recently-viewed-view" class="view">
            <div class="articles-header">
                <h2><i class="fa-solid fa-clock-rotate-left"></i> מאמרים שנצפו לאחרונה</h2>
            </div>
            <div id="recently-viewed-list" class="articles-grid">
                <!-- Recently viewed articles will be loaded here -->
            </div>
        </section>

        <!-- Article Detail View -->
        <section id="article-detail-view" class="view">
            <div class="article-detail-wrapper">
                <aside id="article-toc" class="article-toc">
                    <h4><i class="fa-solid fa-list"></i> תוכן עניינים</h4>
                    <ul id="toc-list"></ul>
                </aside>
                <div class="article-detail-container">
                    <button class="back-btn" onclick="closeArticle()">← חזרה לרשימה</button>
                    <div id="article-detail-content">
                        <!-- Article content will be loaded here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Editor View -->
        <section id="editor-view" class="view">
            <div class="editor-container">
                <!-- Content Import Section -->
                <div class="import-section">
                    <div class="import-box collapsed" id="import-area">
                        <button type="button" class="btn-import-close" onclick="collapseImportBox(event)"><i
                                class="fa-solid fa-xmark"></i></button>
                        <input type="file" id="import-file-input" accept=".md,.markdown,.txt,.docx,.html,.htm" hidden>
                        <div class="import-placeholder" onclick="handleImportClick(event)">
                            <span class="import-icon"><i class="fa-solid fa-file-import"></i></span>
                            <span>ייבוא מקובץ (Word, HTML, Markdown)</span>
                            <span class="import-hint">גרור קובץ או לחץ לבחירה</span>
                        </div>
                    </div>
                </div>

                <div class="editor-header-section">
                    <h2 id="editor-title">יצירת מאמר חדש</h2>
                    <div id="draft-indicator" class="draft-indicator" style="display: none;"></div>
                </div>
                <form id="article-form">
                    <input type="hidden" id="article-id">

                    <div class="form-group">
                        <label for="article-title">כותרת המאמר:</label>
                        <input type="text" id="article-title" required placeholder="הזן כותרת...">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="article-category">קטגוריה:</label>
                            <select id="article-category" required>
                                <option value="">בחר קטגוריה</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="article-department">מחלקה:</label>
                            <select id="article-department" required>
                                <option value="">בחר מחלקה</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="article-priority">עדיפות:</label>
                            <select id="article-priority" required>
                                <option value="">בחר עדיפות</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="article-summary">תקציר:</label>
                        <textarea id="article-summary" rows="2" placeholder="תקציר קצר של המאמר..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="article-content">תוכן המאמר:</label>
                        <div class="editor-scroll-container">
                            <div class="editor-toolbar">
                                <div class="toolbar-group">
                                    <button type="button" onclick="formatText('bold')" title="מודגש (Ctrl+B)"><i
                                            class="fa-solid fa-bold"></i></button>
                                    <button type="button" onclick="formatText('italic')" title="נטוי (Ctrl+I)"><i
                                            class="fa-solid fa-italic"></i></button>
                                    <button type="button" onclick="formatText('underline')" title="קו תחתון (Ctrl+U)"><i
                                            class="fa-solid fa-underline"></i></button>
                                    <button type="button" onclick="formatText('strikeThrough')"
                                        title="קו חוצה (Ctrl+D)"><i class="fa-solid fa-strikethrough"></i></button>
                                </div>
                                <div class="toolbar-separator"></div>
                                <div class="toolbar-group">
                                    <div class="select-wrapper">
                                        <select onchange="changeFontSize(this.value)" class="toolbar-select"
                                            title="גודל טקסט">
                                            <option value="">גודל</option>
                                            <option value="1">קטן מאוד</option>
                                            <option value="2">קטן</option>
                                            <option value="3">רגיל</option>
                                            <option value="4">בינוני</option>
                                            <option value="5">גדול</option>
                                            <option value="6">גדול מאוד</option>
                                            <option value="7">ענק</option>
                                        </select>
                                    </div>
                                    <div class="select-wrapper">
                                        <select onchange="changeFontName(this.value)" class="toolbar-select"
                                            title="גופן">
                                            <option value="">גופן</option>
                                            <option value="Arial">Arial</option>
                                            <option value="Heebo">Heebo</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Verdana">Verdana</option>
                                        </select>
                                    </div>
                                    <input type="color" onchange="changeTextColor(this.value)" title="צבע טקסט"
                                        class="color-picker">
                                    <input type="color" onchange="changeBackColor(this.value)" title="צבע רקע"
                                        class="color-picker">
                                </div>
                                <div class="toolbar-separator"></div>
                                <div class="toolbar-group">
                                    <button type="button" onclick="formatText('justifyLeft')"
                                        title="יישור לשמאל (Ctrl+L)"><i class="fa-solid fa-align-left"></i></button>
                                    <button type="button" onclick="formatText('justifyCenter')" title="מרכז (Ctrl+E)"><i
                                            class="fa-solid fa-align-center"></i></button>
                                    <button type="button" onclick="formatText('justifyRight')"
                                        title="יישור לימין (Ctrl+R)"><i class="fa-solid fa-align-right"></i></button>
                                    <button type="button" onclick="formatText('justifyFull')"
                                        title="יישור מלא (Ctrl+J)"><i class="fa-solid fa-align-justify"></i></button>
                                    <button type="button" onclick="setDirection('ltr')" title="כיוון משמאל לימין"><i
                                            class="fa-solid fa-angles-right"></i></button>
                                    <button type="button" onclick="setDirection('rtl')" title="כיוון מימין לשמאל"><i
                                            class="fa-solid fa-angles-left"></i></button>
                                </div>
                                <div class="toolbar-separator"></div>
                                <div class="toolbar-group">
                                    <button type="button" onclick="formatText('insertUnorderedList')"
                                        title="רשימה (Ctrl+Shift+8)"><i class="fa-solid fa-list-ul"></i></button>
                                    <button type="button" onclick="formatText('insertOrderedList')"
                                        title="רשימה ממוספרת (Ctrl+1)"><i class="fa-solid fa-list-ol"></i></button>
                                    <button type="button" onclick="formatText('indent')" title="הזחה (Ctrl+])"><i
                                            class="fa-solid fa-indent"></i></button>
                                    <button type="button" onclick="formatText('outdent')" title="בטל הזחה (Ctrl+[)"><i
                                            class="fa-solid fa-outdent"></i></button>
                                </div>
                                <div class="toolbar-separator"></div>
                                <div class="toolbar-group">
                                    <button type="button" onclick="insertHeading()" title="כותרת (Ctrl+H)"><i
                                            class="fa-solid fa-heading"></i></button>
                                    <button type="button" onclick="insertLink()" title="קישור (Ctrl+K)"><i
                                            class="fa-solid fa-link"></i></button>
                                    <button type="button" onclick="triggerImageUpload()" title="הוסף תמונה"><i
                                            class="fa-solid fa-image"></i></button>
                                    <button type="button" onclick="insertCodeBlock()" title="בלוק קוד"><i
                                            class="fa-solid fa-code"></i></button>
                                    <button type="button" onclick="insertBlockquote()" title="ציטוט (Ctrl+Q)"><i
                                            class="fa-solid fa-quote-right"></i></button>
                                    <button type="button" onclick="insertHorizontalRule()" title="קו מפריד"><i
                                            class="fa-solid fa-minus"></i></button>
                                    <button type="button" onclick="insertTable()" title="טבלה"><i
                                            class="fa-solid fa-table"></i></button>
                                    <button type="button" onclick="formatText('removeFormat')" title="נקה עיצוב"><i
                                            class="fa-solid fa-eraser"></i></button>
                                </div>
                                <div class="toolbar-separator"></div>
                                <div class="toolbar-group">
                                    <button type="button" class="btn-toggle-preview" onclick="togglePreview()"
                                        title="הצג/הסתר תצוגה מקדימה">
                                        <i class="fa-solid fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="image-input" accept="image/*" hidden
                                onchange="handleImageUpload(event)">
                            <div class="editor-preview-container">
                                <div class="editor-with-preview">
                                    <div class="editor-panel">
                                        <div id="article-content" class="rich-editor" contenteditable="true"></div>
                                    </div>
                                    <div id="preview-panel" class="preview-panel" style="display: none;">
                                        <div class="preview-header">תצוגה מקדימה</div>
                                        <div id="article-preview" class="article-preview"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>תגיות נוספות:</label>
                        <div class="tags-input-container">
                            <input type="text" id="custom-tag-input" placeholder="הוסף תגית...">
                            <button type="button" onclick="addCustomTag()" class="add-tag-btn">+</button>
                        </div>
                        <div id="custom-tags-list" class="custom-tags-list"></div>
                    </div>

                    <!-- File Attachments -->
                    <div class="form-group">
                        <label>קבצים מצורפים:</label>
                        <div class="file-upload-area" id="file-upload-area">
                            <input type="file" id="file-input" multiple
                                accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.png,.jpg,.jpeg,.gif"
                                hidden>
                            <div class="upload-placeholder" onclick="document.getElementById('file-input').click()">
                                <span class="upload-icon"><i class="fa-solid fa-paperclip"></i></span>
                                <span>לחץ להעלאת קבצים או גרור לכאן</span>
                                <span class="upload-formats">PDF, Word, Excel, PowerPoint, תמונות, ועוד</span>
                            </div>
                        </div>
                        <div class="upload-note">
                            <strong>קבצים נתמכים:</strong> PDF, Word (.doc/.docx), Excel (.xls/.xlsx), PowerPoint
                            (.ppt/.pptx), Text (.txt), ZIP, RAR, תמונות (PNG/JPG/GIF)
                        </div>
                        <div id="attachments-list" class="attachments-list"></div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">שמור מאמר</button>
                        <button type="button" class="btn-secondary" onclick="resetForm()">נקה טופס</button>
                        <button type="button" class="btn-danger" id="delete-article-btn" style="display:none;"
                            onclick="deleteArticle()">מחק מאמר</button>
                    </div>
                </form>

                <!-- Table Creator Modal -->
                <div id="table-creator-modal" class="modal-overlay" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>יצירת טבלה</h3>
                            <button type="button" class="modal-close" onclick="closeTableCreatorModal()"><i
                                    class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="table-rows">שורות (כולל כותרת):</label>
                                    <input type="number" id="table-rows" value="3" min="1" max="50">
                                </div>
                                <div class="form-group">
                                    <label for="table-cols">עמודות:</label>
                                    <input type="number" id="table-cols" value="3" min="1" max="20">
                                </div>
                            </div>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="table-header" checked>
                                    <span class="checkmark"></span>
                                    <span class="label-text">שורה ראשונה ככותרת</span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary"
                                onclick="closeTableCreatorModal()">ביטול</button>
                            <button type="button" class="btn-primary" onclick="confirmInsertTable()">הוסף טבלה</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Manage Tags View -->
        <section id="manage-tags-view" class="view">
            <div class="tags-manager-container">
                <h2>ניהול תגיות</h2>

                <div class="tags-sections">
                    <!-- Categories -->
                    <div class="tag-section">
                        <h3>קטגוריות</h3>
                        <div class="add-tag-row">
                            <input type="text" id="new-category" placeholder="קטגוריה חדשה...">
                            <button onclick="addTag('category')" class="btn-add">הוסף</button>
                        </div>
                        <ul id="categories-list" class="tags-list"></ul>
                    </div>

                    <!-- Departments -->
                    <div class="tag-section">
                        <h3>מחלקות</h3>
                        <div class="add-tag-row">
                            <input type="text" id="new-department" placeholder="מחלקה חדשה...">
                            <button onclick="addTag('department')" class="btn-add">הוסף</button>
                        </div>
                        <ul id="departments-list" class="tags-list"></ul>
                    </div>

                    <!-- Priorities -->
                    <div class="tag-section priority-section">
                        <h3>עדיפויות</h3>
                        <div class="priority-creator">
                            <div class="priority-name-row">
                                <input type="text" id="new-priority" placeholder="שם העדיפות..."
                                    class="priority-name-input">
                                <div class="priority-color-wrapper">
                                    <label class="color-label">צבע:</label>
                                    <input type="color" id="new-priority-color" value="#007bff"
                                        class="priority-color-input">
                                </div>
                            </div>
                            <div class="priority-level-row">
                                <label class="level-label">רמת דחיפות:</label>
                                <div class="level-buttons" id="priority-level-buttons">
                                    <button type="button" class="level-btn" data-level="1"
                                        style="--level-color: #22c55e;">
                                        <span class="level-icon"><i class="fa-solid fa-angle-down"></i></span>
                                        <span class="level-text">נמוכה</span>
                                    </button>
                                    <button type="button" class="level-btn" data-level="2"
                                        style="--level-color: #eab308;">
                                        <span class="level-icon"><i class="fa-solid fa-minus"></i></span>
                                        <span class="level-text">בינונית</span>
                                    </button>
                                    <button type="button" class="level-btn active" data-level="3"
                                        style="--level-color: #f97316;">
                                        <span class="level-icon"><i class="fa-solid fa-angle-up"></i></span>
                                        <span class="level-text">גבוהה</span>
                                    </button>
                                    <button type="button" class="level-btn" data-level="4"
                                        style="--level-color: #ef4444;">
                                        <span class="level-icon"><i class="fa-solid fa-angles-up"></i></span>
                                        <span class="level-text">קריטית</span>
                                    </button>
                                </div>
                                <input type="hidden" id="new-priority-level" value="3">
                            </div>
                            <button onclick="addTag('priority')" class="btn-add">הוסף</button>
                        </div>
                        <ul id="priorities-list" class="tags-list"></ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile View -->
        <section id="profile-view" class="view">
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fa-solid fa-user-circle"></i>
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-email">משתמש</h2>
                        <span id="profile-role" class="profile-role-badge">משתמש</span>
                    </div>
                </div>

                <div class="profile-stats">
                    <div class="stat-card">
                        <span class="stat-number" id="profile-article-count">0</span>
                        <span class="stat-label">מאמרים</span>
                    </div>
                </div>

                <div class="profile-articles-section">
                    <h3><i class="fa-solid fa-file-lines"></i> <span id="profile-articles-title">המאמרים שלי</span></h3>
                    <div id="profile-articles-list" class="profile-articles-grid">
                        <!-- Articles will be loaded here -->
                    </div>
                </div>

                <!-- User Management Section (Admin Only) -->
                <div id="user-management-section" class="user-management-section" style="display: none;">
                    <h3><i class="fa-solid fa-users-gear"></i> ניהול משתמשים</h3>
                    <p class="section-description">כאן ניתן להפוך משתמשים למנהלים או להסיר הרשאות מנהל. שינויים נכנסים
                        לתוקף לאחר התנתקות והתחברות מחדש.</p>
                    <div id="users-list" class="users-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <p>© 2025 Knowledge Repository</p>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- API Connection Indicator -->
    <div id="connection-status" class="connection-status">
        <span class="status-dot"></span>
        <span class="status-text">מצב חיבור</span>
    </div>

    <!-- Dark Mode Toggle -->
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
        <span class="theme-icon"><i class="fa-solid fa-moon"></i></span>
    </button>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top" class="scroll-to-top" title="חזרה למעלה">
        <i class="fa-solid fa-arrow-up"></i>
    </button>

    <script src="api-client.js"></script>
    <script type="module" src="js/init.js"></script>
</body>

</html>
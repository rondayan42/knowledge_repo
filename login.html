<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bsmart - התחברות</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Removed async defer to ensure load order, or rely on onload callback -->
    <script src="https://js.hcaptcha.com/1/api.js?onload=onCaptchaLoad&render=explicit" async defer></script>
    <style>
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .auth-box {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: -2px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .btn-auth {
            width: 100%;
            padding: 0.8rem;
            background: var(--primary, #C41E3A);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-auth:hover {
            background: var(--primary-dark, #8B0000);
        }

        .auth-error {
            color: #dc3545;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .h-captcha-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <header class="main-header">
        <div class="header-container">
            <div class="logo-section" onclick="handleLogoClick()" style="cursor: pointer;">
                <img src="logo.png" alt="Bsmart Logo" class="logo">
                <h1>מאגר הידע</h1>
            </div>
        </div>
    </header>

    <main class="auth-container">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchTab('login')">התחברות</div>
                <div class="auth-tab" onclick="switchTab('register')">הרשמה</div>
            </div>

            <div id="login-form" class="auth-form active">
                <div id="login-error" class="auth-error"></div>
                <div class="form-group">
                    <label>אימייל</label>
                    <input type="email" id="login-email" required placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>סיסמה</label>
                    <input type="password" id="login-password" required>
                </div>
                <div id="hcaptcha-login" class="h-captcha-container"></div>
                <button class="btn-auth" onclick="handleLogin()">התחבר</button>
            </div>

            <div id="register-form" class="auth-form">
                <div id="register-error" class="auth-error"></div>
                <div class="form-group">
                    <label>אימייל</label>
                    <input type="email" id="register-email" required placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label>סיסמה</label>
                    <input type="password" id="register-password" required placeholder="לפחות 6 תווים">
                </div>
                <div id="hcaptcha-register" class="h-captcha-container"></div>
                <button class="btn-auth" onclick="handleRegister()">הירשם</button>
            </div>
        </div>
    </main>

    <script src="api-client.js"></script>
    <script>
        let loginWidgetID;
        let registerWidgetID;
        let hCaptchaLoadedResolver;

        function handleLogoClick() {
            const session = API.getSession();
            if (session && session.access_token) {
                window.location.href = 'index.html';
            }
        }

        function switchTab(mode) {
            // Update tabs
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));

            if (mode === 'login') {
                tabs[0].classList.add('active');
            } else {
                tabs[1].classList.add('active');
            }

            // Update forms
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            document.getElementById(mode + '-form').classList.add('active');

            // Clear errors
            document.querySelectorAll('.auth-error').forEach(el => el.style.display = 'none');
        }

        const hCaptchaReady = new Promise(resolve => hCaptchaLoadedResolver = resolve);

        // global callback for hCaptcha
        window.onCaptchaLoad = function () {
            if (hCaptchaLoadedResolver) hCaptchaLoadedResolver();
        };

        // Initialize API on page load
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof checkServerAvailability === 'function') {
                await checkServerAvailability();
            }

            // Check if hCaptcha is already loaded (if script ran before this code)
            if (window.hcaptcha) {
                hCaptchaLoadedResolver();
            }

            // Initialize hCaptcha
            await fetchConfigAndRenderCaptcha();

            // Enable Enter key for login
            const loginInputs = ['login-email', 'login-password'];
            loginInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            handleLogin();
                        }
                    });
                }
            });

            // Enable Enter key for register
            const registerInputs = ['register-email', 'register-password'];
            registerInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            handleRegister();
                        }
                    });
                }
            });
        });

        async function fetchConfigAndRenderCaptcha() {
            try {
                // Fetch site key from backend
                const response = await fetch('/api/auth/config');
                const config = await response.json();

                // Wait for hCaptcha script to load
                await hCaptchaReady;

                if (config.hCaptchaSiteKey && window.hcaptcha) {
                    // Render Login Widget
                    try {
                        loginWidgetID = hcaptcha.render('hcaptcha-login', {
                            sitekey: config.hCaptchaSiteKey
                        });

                        // Render Register Widget
                        registerWidgetID = hcaptcha.render('hcaptcha-register', {
                            sitekey: config.hCaptchaSiteKey
                        });
                    } catch (e) {
                        console.error('Error rendering hCaptcha:', e);
                    }
                }
            } catch (error) {
                console.error('Failed to load hCaptcha config:', error);
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            errorDiv.style.display = 'none';

            // Validate hCaptcha is loaded
            if (!window.hcaptcha || loginWidgetID === undefined) {
                errorDiv.textContent = 'שגיאת טעינת Captcha - אנא רענן את הדף';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate Captcha
            let captchaToken;
            try {
                captchaToken = hcaptcha.getResponse(loginWidgetID);
            } catch (e) {
                console.error('hCaptcha error:', e);
            }

            if (!captchaToken) {
                errorDiv.textContent = 'אנא אמת שאינך רובוט';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                if (!window.API) {
                    errorDiv.textContent = 'שגיאה: API לא נטען';
                    errorDiv.style.display = 'block';
                    return;
                }
                const result = await API.login(email, password, captchaToken);
                if (result.session) {
                    window.location.href = 'index.html';
                } else {
                    throw new Error(result.error || 'Login failed');
                }
            } catch (error) {
                if (window.hcaptcha) hcaptcha.reset(loginWidgetID);
                let message = error.message || 'שגיאה בהתחברות';
                if (message.toLowerCase().includes('missing email or phone')) {
                    message = 'Missing email';
                }
                // Handle pending approval-specific error
                if (message.includes('pending admin approval')) {
                    message = 'החשבון ממתין לאישור מנהל';
                }
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        async function handleRegister() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorDiv = document.getElementById('register-error');

            errorDiv.style.display = 'none';

            // Validate hCaptcha is loaded
            if (!window.hcaptcha || registerWidgetID === undefined) {
                errorDiv.textContent = 'שגיאת טעינת Captcha - אנא רענן את הדף';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate Captcha
            let captchaToken;
            try {
                captchaToken = hcaptcha.getResponse(registerWidgetID);
            } catch (e) {
                console.error('hCaptcha error:', e);
            }

            if (!captchaToken) {
                errorDiv.textContent = 'אנא אמת שאינך רובוט';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                if (!window.API) {
                    errorDiv.textContent = 'שגיאה: API לא נטען';
                    errorDiv.style.display = 'block';
                    return;
                }
                const result = await API.register(email, password, captchaToken);
                if (result.session) {
                    // Auto login after register
                    window.location.href = 'index.html';
                } else if (result.user && result.user.approved === false) {
                    // Success but pending approval
                    errorDiv.style.color = '#FFA500'; // Orange for warning/pending
                    errorDiv.textContent = 'ההרשמה הצליחה! החשבון ממתין לאישור מנהל לפני שתוכל להתחבר.';
                    errorDiv.style.display = 'block';
                    // Clear inputs
                    document.getElementById('register-email').value = '';
                    document.getElementById('register-password').value = '';
                    if (window.hcaptcha) hcaptcha.reset(registerWidgetID);
                } else if (result.user) {
                    // Email confirmation may be required
                    errorDiv.style.color = '#28a745';
                    errorDiv.textContent = 'נרשמת בהצלחה! בדוק את האימייל לאישור.';
                    errorDiv.style.display = 'block';
                    if (window.hcaptcha) hcaptcha.reset(registerWidgetID);
                } else {
                    throw new Error(result.error || 'Registration failed');
                }
            } catch (error) {
                if (window.hcaptcha) hcaptcha.reset(registerWidgetID);
                errorDiv.textContent = error.message || 'שגיאה בהרשמה';
                errorDiv.style.display = 'block';
            }
        }
    </script>
</body>

</html>
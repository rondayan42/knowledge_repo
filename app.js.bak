/* ==========================================
   Bsmart Knowledge Repository - Application Logic
   Supports both localStorage and Server API
   ========================================== */

// ==========================================
// Data Storage & State
// ==========================================

const STORAGE_KEYS = {
    ARTICLES: 'bsmart_articles',
    CATEGORIES: 'bsmart_categories',
    DEPARTMENTS: 'bsmart_departments',
    PRIORITIES: 'bsmart_priorities'
};

// Default data
const DEFAULT_CATEGORIES = ['הדרכה', 'נהלים', 'טכני', 'שירות לקוחות', 'מכירות', 'כללי'];
const DEFAULT_DEPARTMENTS = ['תפעול', 'פיתוח', 'שיווק', 'משאבי אנוש', 'הנהלה', 'תמיכה טכנית'];
const DEFAULT_PRIORITIES = ['גבוהה', 'בינונית', 'נמוכה', 'דחוף'];

// State
let articles = [];
let categories = [];
let departments = [];
let priorities = [];
let currentCustomTags = [];

// Database mode state
let dbCategories = [];
let dbDepartments = [];
let dbPriorities = [];

// ==========================================
// Initialization
// ==========================================

document.addEventListener('DOMContentLoaded', async () => {
    // Check if server API is available
    if (typeof checkServerAvailability === 'function') {
        await checkServerAvailability();
    }
    
    await initializeData();
    setupEventListeners();
    renderTagsManager();
    populateDropdowns();
    filterArticles();
    updateConnectionStatus();
    initThemeToggle();
    initScrollToTop();
});

function updateConnectionStatus() {
    const statusEl = document.getElementById('connection-status');
    if (!statusEl) return;
    
    if (typeof isUsingAPI === 'function' && isUsingAPI()) {
        statusEl.classList.add('connected');
        statusEl.classList.remove('local');
        statusEl.querySelector('.status-text').textContent = 'מחובר לשרת';
    } else {
        statusEl.classList.add('local');
        statusEl.classList.remove('connected');
        statusEl.querySelector('.status-text').textContent = 'אחסון מקומי';
    }
}

async function initializeData() {
    // Check if we should use API
    if (typeof isUsingAPI === 'function' && isUsingAPI()) {
        await initializeFromAPI();
    } else {
        initializeFromLocalStorage();
    }
}

async function initializeFromAPI() {
    try {
        // Load from API
        const [apiCategories, apiDepartments, apiPriorities, apiArticles] = await Promise.all([
            API.getCategories(),
            API.getDepartments(),
            API.getPriorities(),
            API.getArticles()
        ]);
        
        dbCategories = apiCategories || [];
        dbDepartments = apiDepartments || [];
        dbPriorities = apiPriorities || [];
        
        // Map to string arrays for UI compatibility
        categories = dbCategories.map(c => c.name);
        departments = dbDepartments.map(d => d.name);
        priorities = dbPriorities.map(p => p.name);
        
        // Map articles to UI format
        articles = (apiArticles || []).map(a => ({
            id: String(a.id),
            title: a.title,
            summary: a.summary,
            content: a.content,
            category: a.category_name,
            department: a.department_name,
            priority: a.priority_name,
            customTags: a.tags ? a.tags.map(t => t.name) : [],
            attachments: a.attachments ? a.attachments.map(att => ({
                id: String(att.id),
                name: att.file_name,
                size: att.size,
                url: att.url,
                mime_type: att.mime_type
            })) : [],
            createdAt: a.created_at,
            updatedAt: a.updated_at,
            views: a.views,
            // Keep DB IDs for updates
            _category_id: a.category_id,
            _department_id: a.department_id,
            _priority_id: a.priority_id
        }));
        
        console.log('Data loaded from API');
    } catch (error) {
        console.error('Error loading from API:', error);
        initializeFromLocalStorage();
    }
}

function initializeFromLocalStorage() {
    // Load or initialize articles
    const storedArticles = localStorage.getItem(STORAGE_KEYS.ARTICLES);
    articles = storedArticles ? JSON.parse(storedArticles) : getSampleArticles();
    
    // Load or initialize categories
    const storedCategories = localStorage.getItem(STORAGE_KEYS.CATEGORIES);
    categories = storedCategories ? JSON.parse(storedCategories) : [...DEFAULT_CATEGORIES];
    
    // Load or initialize departments
    const storedDepartments = localStorage.getItem(STORAGE_KEYS.DEPARTMENTS);
    departments = storedDepartments ? JSON.parse(storedDepartments) : [...DEFAULT_DEPARTMENTS];
    
    // Load or initialize priorities
    const storedPriorities = localStorage.getItem(STORAGE_KEYS.PRIORITIES);
    priorities = storedPriorities ? JSON.parse(storedPriorities) : [...DEFAULT_PRIORITIES];
    
    // Save if using defaults
    if (!storedArticles) saveArticles();
    if (!storedCategories) saveCategories();
    if (!storedDepartments) saveDepartments();
    if (!storedPriorities) savePriorities();
}

function getSampleArticles() {
    return [
        {
            id: generateId(),
            title: 'ברוכים הבאים למאגר הידע',
            summary: 'מאמר פתיחה עם הסבר על שימוש במאגר הידע הארגוני',
            content: '<h2>ברוכים הבאים!</h2><p>מאגר הידע של Bsmart הוא המקום המרכזי לכל המידע הארגוני שלנו.</p><h3>איך להשתמש במאגר?</h3><ul><li>חפשו מאמרים לפי נושא או מילות מפתח</li><li>סננו לפי קטגוריה, מחלקה או עדיפות</li><li>צרו מאמרים חדשים בעזרת העורך</li></ul><p>בהצלחה!</p>',
            category: 'כללי',
            department: 'הנהלה',
            priority: 'גבוהה',
            customTags: ['חדש', 'חשוב'],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: generateId(),
            title: 'נוהל עבודה עם מערכת ה-CRM',
            summary: 'הנחיות מפורטות לעבודה נכונה עם מערכת ניהול הלקוחות',
            content: '<h2>נוהל עבודה עם מערכת ה-CRM</h2><p>מסמך זה מפרט את נהלי העבודה הנכונים עם מערכת ניהול הלקוחות שלנו.</p><h3>כניסה למערכת</h3><ol><li>היכנסו לכתובת המערכת</li><li>הזינו את שם המשתמש והסיסמה</li><li>לחצו על "התחבר"</li></ol><h3>עדכון פרטי לקוח</h3><p>לעדכון פרטי לקוח, חפשו את הלקוח בשורת החיפוש ולחצו על "עריכה".</p>',
            category: 'נהלים',
            department: 'מכירות',
            priority: 'בינונית',
            customTags: ['CRM', 'לקוחות'],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        }
    ];
}

// ==========================================
// Event Listeners
// ==========================================

function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const view = e.target.dataset.view;
            showView(view);
            
            // Update active state
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
        });
    });
    
    // Article form
    document.getElementById('article-form').addEventListener('submit', handleArticleSubmit);
    
    // Search
    document.getElementById('search-input').addEventListener('input', debounce(filterArticles, 300));
    
    // Filter dropdowns
    document.getElementById('filter-category').addEventListener('change', filterArticles);
    document.getElementById('filter-department').addEventListener('change', filterArticles);
    document.getElementById('filter-priority').addEventListener('change', filterArticles);
    document.getElementById('sort-articles').addEventListener('change', filterArticles);
    
    // Custom tag input - Enter key
    document.getElementById('custom-tag-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addCustomTag();
        }
    });
}

// ==========================================
// View Management
// ==========================================

function showView(viewName) {
    // Hide all views
    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
    
    // Show requested view
    const view = document.getElementById(`${viewName}-view`);
    if (view) {
        view.classList.add('active');
    }
    
    // Update nav buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === viewName);
    });
    
    // Refresh content if needed
    if (viewName === 'articles') {
        renderArticles();
    } else if (viewName === 'manage-tags') {
        renderTagsManager();
    } else if (viewName === 'editor') {
        populateDropdowns();
    }
}

// ==========================================
// Articles Management
// ==========================================

function renderArticles(filteredArticles = null) {
    const articlesToRender = filteredArticles || articles;
    const container = document.getElementById('articles-list');
    
    if (articlesToRender.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon"><i class="fa-solid fa-file-lines"></i></div>
                <h3>אין מאמרים להצגה</h3>
                <p>צרו את המאמר הראשון שלכם באמצעות עורך המאמרים</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = articlesToRender.map(article => `
        <div class="article-card" onclick="viewArticle('${article.id}')">
            <div class="article-card-header">
                <h3>${escapeHtml(article.title)}</h3>
                <div class="article-meta">
                    <span><i class="fa-solid fa-folder"></i> ${escapeHtml(article.category)}</span>
                    <span><i class="fa-solid fa-building"></i> ${escapeHtml(article.department)}</span>
                    ${article.attachments && article.attachments.length > 0 ? `<span><i class="fa-solid fa-paperclip"></i> ${article.attachments.length} קבצים</span>` : ''}
                </div>
            </div>
            <div class="article-card-body">
                <p class="article-summary">${escapeHtml(article.summary || 'אין תקציר')}</p>
                <div class="article-tags">
                    <span class="tag category">${escapeHtml(article.category)}</span>
                    <span class="tag department">${escapeHtml(article.department)}</span>
                    <span class="tag priority">${escapeHtml(article.priority)}</span>
                    ${article.customTags ? article.customTags.map(tag => 
                        `<span class="tag">${escapeHtml(tag)}</span>`
                    ).join('') : ''}
                </div>
            </div>
            <div class="article-card-footer">
                <span class="article-date">עודכן: ${formatDate(article.updatedAt)}</span>
                <div class="article-actions">
                    <button class="btn-edit" onclick="event.stopPropagation(); editArticle('${article.id}')">עריכה</button>
                    <button class="btn-view" onclick="event.stopPropagation(); viewArticle('${article.id}')">צפייה</button>
                </div>
            </div>
        </div>
    `).join('');
}

function viewArticle(id) {
    const article = articles.find(a => a.id === id);
    if (!article) return;
    
    // Generate attachments HTML
    let attachmentsHtml = '';
    if (article.attachments && article.attachments.length > 0) {
        attachmentsHtml = `
            <div class="article-attachments">
                <h3><i class="fa-solid fa-paperclip"></i> קבצים מצורפים</h3>
                <div class="download-list">
                    ${article.attachments.map(att => `
                        <a href="${att.data}" download="${escapeHtml(att.name)}" class="download-item">
                            <span class="file-icon">${getFileIconForView(att.name)}</span>
                            <div class="file-info">
                                <span class="file-name">${escapeHtml(att.name)}</span>
                                <span class="file-size">${formatFileSizeForView(att.size)}</span>
                            </div>
                            <span class="download-icon"><i class="fa-solid fa-download"></i></span>
                        </a>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    const container = document.getElementById('article-detail-content');
    container.innerHTML = `
        <div class="article-detail-header">
            <h1>${escapeHtml(article.title)}</h1>
            <div class="article-detail-meta">
                <span class="tag category">${escapeHtml(article.category)}</span>
                <span class="tag department">${escapeHtml(article.department)}</span>
                <span class="tag priority">${escapeHtml(article.priority)}</span>
                ${article.customTags ? article.customTags.map(tag => 
                    `<span class="tag">${escapeHtml(tag)}</span>`
                ).join('') : ''}
            </div>
            ${article.summary ? `<p><strong>תקציר:</strong> ${escapeHtml(article.summary)}</p>` : ''}
        </div>
        <div class="article-detail-body">
            ${article.content}
        </div>
        ${attachmentsHtml}
        <div class="article-detail-footer">
            <div>
                <p><strong>נוצר:</strong> ${formatDate(article.createdAt)}</p>
                <p><strong>עודכן:</strong> ${formatDate(article.updatedAt)}</p>
            </div>
            <div class="footer-actions">
                <button class="btn-print" onclick="window.print()"><i class="fa-solid fa-print"></i> הדפסה</button>
                <button class="btn-edit" onclick="editArticle('${article.id}')">עריכת מאמר</button>
            </div>
        </div>
    `;
    
    showView('article-detail');
    generateTableOfContents();
}

// Helper functions for article view
function getFileIconForView(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
        pdf: '<i class="fa-solid fa-file-pdf"></i>',
        doc: '<i class="fa-solid fa-file-word"></i>', docx: '<i class="fa-solid fa-file-word"></i>',
        xls: '<i class="fa-solid fa-file-excel"></i>', xlsx: '<i class="fa-solid fa-file-excel"></i>',
        ppt: '<i class="fa-solid fa-file-powerpoint"></i>', pptx: '<i class="fa-solid fa-file-powerpoint"></i>',
        txt: '<i class="fa-solid fa-file-lines"></i>',
        zip: '<i class="fa-solid fa-file-zipper"></i>', rar: '<i class="fa-solid fa-file-zipper"></i>',
        png: '<i class="fa-solid fa-file-image"></i>', jpg: '<i class="fa-solid fa-file-image"></i>', jpeg: '<i class="fa-solid fa-file-image"></i>', gif: '<i class="fa-solid fa-file-image"></i>'
    };
    return icons[ext] || '<i class="fa-solid fa-paperclip"></i>';
}

function formatFileSizeForView(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function editArticle(id) {
    const article = articles.find(a => a.id === id);
    if (!article) return;
    
    // Populate form
    document.getElementById('article-id').value = article.id;
    document.getElementById('article-title').value = article.title;
    document.getElementById('article-summary').value = article.summary || '';
    document.getElementById('article-content').innerHTML = article.content;
    
    // Populate dropdowns and select values
    populateDropdowns();
    setTimeout(() => {
        document.getElementById('article-category').value = article.category;
        document.getElementById('article-department').value = article.department;
        document.getElementById('article-priority').value = article.priority;
    }, 50);
    
    // Set custom tags
    currentCustomTags = article.customTags ? [...article.customTags] : [];
    renderCustomTags();
    
    // Set attachments
    currentAttachments = article.attachments ? [...article.attachments] : [];
    renderAttachments();
    
    // Update UI
    document.getElementById('editor-title').textContent = 'עריכת מאמר';
    document.getElementById('delete-article-btn').style.display = 'inline-block';
    
    showView('editor');
}

async function handleArticleSubmit(e) {
    e.preventDefault();
    
    const id = document.getElementById('article-id').value;
    const title = document.getElementById('article-title').value.trim();
    const summary = document.getElementById('article-summary').value.trim();
    const content = document.getElementById('article-content').innerHTML;
    const category = document.getElementById('article-category').value;
    const department = document.getElementById('article-department').value;
    const priority = document.getElementById('article-priority').value;
    
    if (!title || !category || !department || !priority) {
        showToast('נא למלא את כל השדות הנדרשים', 'error');
        return;
    }
    
    const now = new Date().toISOString();
    
    // Check if using API
    if (typeof isUsingAPI === 'function' && isUsingAPI()) {
        try {
            // Get IDs from names
            const categoryObj = dbCategories.find(c => c.name === category);
            const departmentObj = dbDepartments.find(d => d.name === department);
            const priorityObj = dbPriorities.find(p => p.name === priority);
            
            const articleData = {
                title,
                summary,
                content,
                category_id: categoryObj ? categoryObj.id : null,
                department_id: departmentObj ? departmentObj.id : null,
                priority_id: priorityObj ? priorityObj.id : null,
                tags: [...currentCustomTags],
                attachmentIds: currentAttachments.map(att => att.id).filter(Boolean)
            };
            
            if (id) {
                await API.updateArticle(id, articleData);
                showToast('המאמר עודכן בהצלחה!', 'success');
            } else {
                await API.createArticle(articleData);
                showToast('המאמר נוצר בהצלחה!', 'success');
            }
            
            // Reload articles from API
            await initializeFromAPI();
        } catch (error) {
            console.error('Error saving article:', error);
            showToast('שגיאה בשמירת המאמר', 'error');
            return;
        }
    } else {
        // Local storage mode
        if (id) {
            // Update existing article
            const index = articles.findIndex(a => a.id === id);
            if (index !== -1) {
                articles[index] = {
                    ...articles[index],
                    title,
                    summary,
                    content,
                    category,
                    department,
                    priority,
                    customTags: [...currentCustomTags],
                    attachments: [...currentAttachments],
                    updatedAt: now
                };
                showToast('המאמר עודכן בהצלחה!', 'success');
            }
        } else {
            // Create new article
            const newArticle = {
                id: generateId(),
                title,
                summary,
                content,
                category,
                department,
                priority,
                customTags: [...currentCustomTags],
                attachments: [...currentAttachments],
                createdAt: now,
                updatedAt: now
            };
            articles.unshift(newArticle);
            showToast('המאמר נוצר בהצלחה!', 'success');
        }
        
        saveArticles();
    }
    
    resetForm();
    filterArticles();
    showView('articles');
}

async function deleteArticle() {
    const id = document.getElementById('article-id').value;
    if (!id) return;
    
    if (confirm('האם אתה בטוח שברצונך למחוק מאמר זה?')) {
        if (typeof isUsingAPI === 'function' && isUsingAPI()) {
            try {
                await API.deleteArticle(id);
                await initializeFromAPI();
            } catch (error) {
                console.error('Error deleting article:', error);
                showToast('שגיאה במחיקת המאמר', 'error');
                return;
            }
        } else {
            articles = articles.filter(a => a.id !== id);
            saveArticles();
        }
        showToast('המאמר נמחק בהצלחה!', 'success');
        resetForm();
        filterArticles();
        showView('articles');
    }
}

function resetForm() {
    document.getElementById('article-form').reset();
    document.getElementById('article-id').value = '';
    document.getElementById('article-content').innerHTML = '';
    document.getElementById('editor-title').textContent = 'יצירת מאמר חדש';
    document.getElementById('delete-article-btn').style.display = 'none';
    currentCustomTags = [];
    renderCustomTags();
    populateDropdowns();
}

function filterArticles() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const categoryFilter = document.getElementById('filter-category').value;
    const departmentFilter = document.getElementById('filter-department').value;
    const priorityFilter = document.getElementById('filter-priority').value;
    const sortValue = document.getElementById('sort-articles').value;
    
    let filtered = articles.filter(article => {
        // Search filter
        const matchesSearch = !searchTerm || 
            article.title.toLowerCase().includes(searchTerm) ||
            (article.summary && article.summary.toLowerCase().includes(searchTerm)) ||
            article.content.toLowerCase().includes(searchTerm) ||
            (article.customTags && article.customTags.some(tag => tag.toLowerCase().includes(searchTerm)));
        
        // Category filter
        const matchesCategory = !categoryFilter || article.category === categoryFilter;
        
        // Department filter
        const matchesDepartment = !departmentFilter || article.department === departmentFilter;
        
        // Priority filter
        const matchesPriority = !priorityFilter || article.priority === priorityFilter;
        
        return matchesSearch && matchesCategory && matchesDepartment && matchesPriority;
    });

    // Sorting
    filtered.sort((a, b) => {
        switch (sortValue) {
            case 'date-asc':
                return new Date(a.updatedAt) - new Date(b.updatedAt);
            case 'date-desc':
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            case 'title-asc':
                return a.title.localeCompare(b.title, 'he');
            case 'title-desc':
                return b.title.localeCompare(a.title, 'he');
            case 'priority':
                const priorityOrder = { 'דחוף': 4, 'גבוהה': 3, 'בינונית': 2, 'נמוכה': 1 };
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
            default:
                return 0;
        }
    });
    
    renderArticles(filtered);
}

// ==========================================
// Tags Management
// ==========================================

function renderTagsManager() {
    // Categories
    const categoriesList = document.getElementById('categories-list');
    categoriesList.innerHTML = categories.map(cat => `
        <li>
            <span>${escapeHtml(cat)}</span>
            <button class="btn-delete-tag" onclick="removeTag('category', '${escapeHtml(cat)}')" title="מחק"><i class="fa-solid fa-xmark"></i></button>
        </li>
    `).join('');
    
    // Departments
    const departmentsList = document.getElementById('departments-list');
    departmentsList.innerHTML = departments.map(dep => `
        <li>
            <span>${escapeHtml(dep)}</span>
            <button class="btn-delete-tag" onclick="removeTag('department', '${escapeHtml(dep)}')" title="מחק"><i class="fa-solid fa-xmark"></i></button>
        </li>
    `).join('');
    
    // Priorities
    const prioritiesList = document.getElementById('priorities-list');
    prioritiesList.innerHTML = priorities.map(pri => `
        <li>
            <span>${escapeHtml(pri)}</span>
            <button class="btn-delete-tag" onclick="removeTag('priority', '${escapeHtml(pri)}')" title="מחק"><i class="fa-solid fa-xmark"></i></button>
        </li>
    `).join('');
}

function addTag(type) {
    const input = document.getElementById(`new-${type}`);
    const value = input.value.trim();
    
    if (!value) {
        showToast('נא להזין ערך', 'error');
        return;
    }
    
    let list, saveFunc;
    switch(type) {
        case 'category':
            if (categories.includes(value)) {
                showToast('קטגוריה זו כבר קיימת', 'error');
                return;
            }
            categories.push(value);
            saveFunc = saveCategories;
            break;
        case 'department':
            if (departments.includes(value)) {
                showToast('מחלקה זו כבר קיימת', 'error');
                return;
            }
            departments.push(value);
            saveFunc = saveDepartments;
            break;
        case 'priority':
            if (priorities.includes(value)) {
                showToast('עדיפות זו כבר קיימת', 'error');
                return;
            }
            priorities.push(value);
            saveFunc = savePriorities;
            break;
    }
    
    // Use API if available
    if (typeof isUsingAPI === 'function' && isUsingAPI()) {
        handleAddTagAPI(type, value, input);
        return;
    }
    
    saveFunc();
    input.value = '';
    renderTagsManager();
    populateDropdowns();
    showToast('התגית נוספה בהצלחה!', 'success');
}

async function handleAddTagAPI(type, value, input) {
    try {
        switch(type) {
            case 'category':
                await API.createCategory(value);
                break;
            case 'department':
                await API.createDepartment(value);
                break;
            case 'priority':
                await API.createPriority(value, 0);
                break;
        }
        await initializeFromAPI();
        input.value = '';
        renderTagsManager();
        populateDropdowns();
        showToast('התגית נוספה בהצלחה!', 'success');
    } catch (error) {
        console.error('Error adding tag:', error);
        showToast('שגיאה בהוספת התגית', 'error');
    }
}

async function removeTag(type, value) {
    // Check if tag is in use
    const inUse = articles.some(article => {
        switch(type) {
            case 'category': return article.category === value;
            case 'department': return article.department === value;
            case 'priority': return article.priority === value;
        }
    });
    
    if (inUse) {
        showToast('לא ניתן למחוק תגית שנמצאת בשימוש במאמרים', 'error');
        return;
    }
    
    if (!confirm(`האם למחוק את התגית "${value}"?`)) return;
    
    // Use API if available
    if (typeof isUsingAPI === 'function' && isUsingAPI()) {
        try {
            let id;
            switch(type) {
                case 'category':
                    id = dbCategories.find(c => c.name === value)?.id;
                    if (id) await API.deleteCategory(id);
                    break;
                case 'department':
                    id = dbDepartments.find(d => d.name === value)?.id;
                    if (id) await API.deleteDepartment(id);
                    break;
                case 'priority':
                    id = dbPriorities.find(p => p.name === value)?.id;
                    if (id) await API.deletePriority(id);
                    break;
            }
            await initializeFromAPI();
            renderTagsManager();
            populateDropdowns();
            showToast('התגית נמחקה בהצלחה!', 'success');
        } catch (error) {
            console.error('Error removing tag:', error);
            showToast('שגיאה במחיקת התגית', 'error');
        }
        return;
    }
    
    switch(type) {
        case 'category':
            categories = categories.filter(c => c !== value);
            saveCategories();
            break;
        case 'department':
            departments = departments.filter(d => d !== value);
            saveDepartments();
            break;
        case 'priority':
            priorities = priorities.filter(p => p !== value);
            savePriorities();
            break;
    }
    
    renderTagsManager();
    populateDropdowns();
    showToast('התגית נמחקה בהצלחה!', 'success');
}

function populateDropdowns() {
    // Filter dropdowns
    populateSelect('filter-category', categories, true);
    populateSelect('filter-department', departments, true);
    populateSelect('filter-priority', priorities, true);
    
    // Editor dropdowns
    populateSelect('article-category', categories, false);
    populateSelect('article-department', departments, false);
    populateSelect('article-priority', priorities, false);
}

function populateSelect(selectId, options, includeAll) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const currentValue = select.value;
    select.innerHTML = includeAll 
        ? '<option value="">הכל</option>'
        : '<option value="">בחר...</option>';
    
    options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
    
    // Restore previous value if it still exists
    if (currentValue && options.includes(currentValue)) {
        select.value = currentValue;
    }
}

// ==========================================
// Custom Tags (Article-specific)
// ==========================================

function addCustomTag() {
    const input = document.getElementById('custom-tag-input');
    const value = input.value.trim();
    
    if (!value) return;
    
    if (currentCustomTags.includes(value)) {
        showToast('תגית זו כבר קיימת', 'error');
        return;
    }
    
    currentCustomTags.push(value);
    input.value = '';
    renderCustomTags();
}

function removeCustomTag(tag) {
    currentCustomTags = currentCustomTags.filter(t => t !== tag);
    renderCustomTags();
}

function renderCustomTags() {
    const container = document.getElementById('custom-tags-list');
    container.innerHTML = currentCustomTags.map(tag => `
        <span class="custom-tag">
            ${escapeHtml(tag)}
            <button class="remove-tag" onclick="removeCustomTag('${escapeHtml(tag)}')" type="button"><i class="fa-solid fa-xmark"></i></button>
        </span>
    `).join('');
}

// ==========================================
// Rich Text Editor Functions
// ==========================================

function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('article-content').focus();
}

function changeFontSize(size) {
    if (size) {
        document.execCommand('fontSize', false, size);
        document.getElementById('article-content').focus();
    }
}

function changeFontName(font) {
    if (font) {
        document.execCommand('fontName', false, font);
        document.getElementById('article-content').focus();
    }
}

function changeTextColor(color) {
    document.execCommand('foreColor', false, color);
    document.getElementById('article-content').focus();
}

function changeBackColor(color) {
    document.execCommand('backColor', false, color);
    document.getElementById('article-content').focus();
}

function insertHeading() {
    const selection = window.getSelection();
    if (selection.toString()) {
        document.execCommand('formatBlock', false, 'h3');
    } else {
        document.execCommand('insertHTML', false, '<h3>כותרת</h3>');
    }
    document.getElementById('article-content').focus();
}

function insertLink() {
    const url = prompt('הזן כתובת URL:');
    if (url) {
        document.execCommand('createLink', false, url);
    }
    document.getElementById('article-content').focus();
}

// Make editor functions globally available
window.formatText = formatText;
window.changeFontSize = changeFontSize;
window.changeFontName = changeFontName;
window.changeTextColor = changeTextColor;
window.changeBackColor = changeBackColor;
window.insertHeading = insertHeading;
window.insertLink = insertLink;

// ==========================================
// Storage Functions
// ==========================================

function saveArticles() {
    localStorage.setItem(STORAGE_KEYS.ARTICLES, JSON.stringify(articles));
}

function saveCategories() {
    localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categories));
}

function saveDepartments() {
    localStorage.setItem(STORAGE_KEYS.DEPARTMENTS, JSON.stringify(departments));
}

function savePriorities() {
    localStorage.setItem(STORAGE_KEYS.PRIORITIES, JSON.stringify(priorities));
}

// ==========================================
// Utility Functions
// ==========================================

function generateId() {
    return 'art_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('he-IL', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + type;
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Make functions globally available for inline onclick handlers
window.showView = showView;
window.viewArticle = viewArticle;
window.editArticle = editArticle;
window.deleteArticle = deleteArticle;
window.resetForm = resetForm;
window.addTag = addTag;
window.removeTag = removeTag;
window.addCustomTag = addCustomTag;
window.removeCustomTag = removeCustomTag;
window.formatText = formatText;
window.insertHeading = insertHeading;
window.insertLink = insertLink;
window.handleMarkdownClick = handleMarkdownClick;
window.collapseImportBox = collapseImportBox;

// ==========================================
// File Attachments System
// ==========================================

let currentAttachments = [];
let uploadsInProgress = 0;

function initFileUpload() {
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('file-upload-area');
    
    if (!fileInput || !uploadArea) return;
    
    // File input change
    fileInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });
}

function handleFileSelect(e) {
    handleFiles(e.target.files);
    e.target.value = ''; // Reset input
}

function handleFiles(files) {
    const allowedTypes = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain',
        'application/zip',
        'application/x-rar-compressed',
        'image/png',
        'image/jpeg',
        'image/gif'
    ];
    
    const maxSize = 10 * 1024 * 1024; // 10MB
    
    for (const file of files) {
        // Check file type
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|zip|rar|png|jpg|jpeg|gif)$/i)) {
            showToast(`סוג קובץ לא נתמך: ${file.name}`, 'error');
            continue;
        }
        
        // Check file size
        if (file.size > maxSize) {
            showToast(`הקובץ גדול מדי (מקסימום 10MB): ${file.name}`, 'error');
            continue;
        }

        // If API is available, upload to server/cloud
        if (typeof isUsingAPI === 'function' && isUsingAPI()) {
            uploadsInProgress += 1;
            renderAttachments();
            showToast(`מעלה את "${file.name}"...`, 'info');
            API.uploadAttachment(file)
                .then(att => {
                    currentAttachments.push({
                        id: String(att.id),
                        name: att.file_name,
                        size: att.size,
                        url: att.url,
                        mime_type: att.mime_type
                    });
                    uploadsInProgress = Math.max(0, uploadsInProgress - 1);
                    renderAttachments();
                    showToast(`הקובץ "${file.name}" הועלה ונשמר בענן`, 'success');
                })
                .catch(err => {
                    console.error('Upload error', err);
                    uploadsInProgress = Math.max(0, uploadsInProgress - 1);
                    renderAttachments();
                    showToast(`שגיאה בהעלאת הקובץ: ${file.name}`, 'error');
                });
        } else {
            // Local fallback: base64 in localStorage
            const reader = new FileReader();
            reader.onload = (e) => {
                const attachment = {
                    id: 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result
                };
                currentAttachments.push(attachment);
                renderAttachments();
                showToast(`הקובץ "${file.name}" נוסף בהצלחה`, 'success');
            };
            reader.readAsDataURL(file);
        }
    }
}

function renderAttachments() {
    const container = document.getElementById('attachments-list');
    if (!container) return;
    
    const uploadingHtml = uploadsInProgress > 0 ? `
        <div class="uploading-indicator">
            <span class="spinner"></span>
            <span>מעלה ${uploadsInProgress} קובץ${uploadsInProgress > 1 ? 'ים' : ''}...</span>
        </div>
    ` : '';

    const itemsHtml = currentAttachments.map(att => `
        <div class="attachment-item">
            <div class="attachment-info">
                <span class="attachment-icon">${getFileIcon(att.name)}</span>
                <div class="attachment-details">
                    <span class="attachment-name">${escapeHtml(att.name)}</span>
                    <span class="attachment-size">${formatFileSize(att.size)}</span>
                </div>
            </div>
            <div class="attachment-actions">
                ${att.url ? `<a class="btn-download" href="${att.url}" download target="_blank">הורדה</a>` : ''}
                <button type="button" class="btn-remove-attachment" onclick="removeAttachment('${att.id}')">הסר</button>
            </div>
        </div>
    `).join('');

    if (!itemsHtml && !uploadingHtml) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = uploadingHtml + itemsHtml;
}

function removeAttachment(id) {
    currentAttachments = currentAttachments.filter(a => a.id !== id);
    renderAttachments();
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
        pdf: '<i class="fa-solid fa-file-pdf"></i>',
        doc: '<i class="fa-solid fa-file-word"></i>', docx: '<i class="fa-solid fa-file-word"></i>',
        xls: '<i class="fa-solid fa-file-excel"></i>', xlsx: '<i class="fa-solid fa-file-excel"></i>',
        ppt: '<i class="fa-solid fa-file-powerpoint"></i>', pptx: '<i class="fa-solid fa-file-powerpoint"></i>',
        txt: '<i class="fa-solid fa-file-lines"></i>',
        zip: '<i class="fa-solid fa-file-zipper"></i>', rar: '<i class="fa-solid fa-file-zipper"></i>',
        png: '<i class="fa-solid fa-file-image"></i>', jpg: '<i class="fa-solid fa-file-image"></i>', jpeg: '<i class="fa-solid fa-file-image"></i>', gif: '<i class="fa-solid fa-file-image"></i>'
    };
    return icons[ext] || '<i class="fa-solid fa-paperclip"></i>';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ==========================================
// Markdown Import System
// ==========================================

function initMarkdownImport() {
    const mdInput = document.getElementById('markdown-input');
    const importArea = document.getElementById('markdown-import-area');
    
    if (!mdInput || !importArea) return;
    
    // File input change
    mdInput.addEventListener('change', handleMarkdownSelect);
    
    // Drag and drop
    importArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        importArea.classList.add('drag-over');
        expandImportBox();
    });
    
    importArea.addEventListener('dragleave', () => {
        importArea.classList.remove('drag-over');
    });
    
    importArea.addEventListener('drop', (e) => {
        e.preventDefault();
        importArea.classList.remove('drag-over');
        expandImportBox();
        if (e.dataTransfer.files.length > 0) {
            handleMarkdownFile(e.dataTransfer.files[0]);
        }
    });
}

function handleMarkdownSelect(e) {
    if (e.target.files.length > 0) {
        handleMarkdownFile(e.target.files[0]);
    }
    e.target.value = '';
}

function handleMarkdownFile(file) {
    if (!file.name.match(/\.(md|markdown|txt)$/i)) {
        showToast('נא לבחור קובץ Markdown (.md, .markdown, .txt)', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const markdown = e.target.result;
        const html = markdownToHtml(markdown);
        
        // Extract title from first heading or filename
        let title = file.name.replace(/\.(md|markdown|txt)$/i, '');
        const titleMatch = markdown.match(/^#\s+(.+)$/m);
        if (titleMatch) {
            title = titleMatch[1].trim();
        }
        
        // Extract summary from first paragraph
        let summary = '';
        const paragraphMatch = markdown.match(/^(?!#)(.+)$/m);
        if (paragraphMatch) {
            summary = paragraphMatch[1].trim().substring(0, 200);
        }
        
        // Populate form
        document.getElementById('article-title').value = title;
        document.getElementById('article-summary').value = summary;
        document.getElementById('article-content').innerHTML = html;
        
        showToast('קובץ Markdown יובא בהצלחה!', 'success');
    };
    reader.readAsText(file);
}

function markdownToHtml(markdown) {
    let html = markdown;
    
    // Escape HTML entities first
    html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Headers (must be done in order from h6 to h1)
    html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
    html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
    html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
    html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
    html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
    html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
    
    // Bold and italic
    html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
    html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
    html = html.replace(/_(.+?)_/g, '<em>$1</em>');
    
    // Strikethrough
    html = html.replace(/~~(.+?)~~/g, '<del>$1</del>');
    
    // Code blocks
    html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
    html = html.replace(/`(.+?)`/g, '<code>$1</code>');
    
    // Links
    html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>');
    
    // Images
    html = html.replace(/!\[(.+?)\]\((.+?)\)/g, '<img src="$2" alt="$1" style="max-width:100%">');
    
    // Horizontal rule
    html = html.replace(/^---$/gm, '<hr>');
    html = html.replace(/^\*\*\*$/gm, '<hr>');
    
    // Blockquotes
    html = html.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
    
    // Unordered lists
    html = html.replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
    
    // Ordered lists
    html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
    
    // Paragraphs (lines that aren't already wrapped)
    const lines = html.split('\n');
    html = lines.map(line => {
        line = line.trim();
        if (!line) return '';
        if (line.match(/^<(h[1-6]|ul|ol|li|pre|blockquote|hr|p)/)) return line;
        return `<p>${line}</p>`;
    }).join('\n');
    
    // Clean up empty paragraphs
    html = html.replace(/<p><\/p>/g, '');
    html = html.replace(/<p>(<h[1-6]>)/g, '$1');
    html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
    html = html.replace(/<p>(<ul>)/g, '$1');
    html = html.replace(/(<\/ul>)<\/p>/g, '$1');
    html = html.replace(/<p>(<blockquote>)/g, '$1');
    html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
    html = html.replace(/<p>(<pre>)/g, '$1');
    html = html.replace(/(<\/pre>)<\/p>/g, '$1');
    html = html.replace(/<p><hr><\/p>/g, '<hr>');
    
    return html;
}

// ==========================================
// Markdown Import Toggle Controls
// ==========================================

function handleMarkdownClick(e) {
    const box = document.getElementById('markdown-import-area');
    if (!box) return;
    // If collapsed, expand first instead of opening file picker
    if (box.classList.contains('collapsed')) {
        expandImportBox();
        return;
    }
    // Already expanded -> open file dialog
    const mdInput = document.getElementById('markdown-input');
    if (mdInput) {
        mdInput.click();
    }
}

function expandImportBox() {
    const box = document.getElementById('markdown-import-area');
    if (!box) return;
    box.classList.add('expanded');
    box.classList.remove('collapsed');
}

function collapseImportBox(e) {
    if (e) e.stopPropagation();
    const box = document.getElementById('markdown-import-area');
    if (!box) return;
    box.classList.remove('expanded');
    box.classList.add('collapsed');
    box.classList.remove('drag-over');
}

// ==========================================
// Update Form Handling for Attachments
// ==========================================

// Store original resetForm and extend it
const originalResetForm = resetForm;
window.resetForm = function() {
    originalResetForm();
    currentAttachments = [];
    renderAttachments();
};

// Initialize file upload and markdown import on DOM ready
document.addEventListener('DOMContentLoaded', () => {
    initFileUpload();
    initMarkdownImport();
});

// ==========================================
// Dark Mode Toggle
// ==========================================

function initThemeToggle() {
    const toggleBtn = document.getElementById('theme-toggle');
    const themeIcon = toggleBtn?.querySelector('.theme-icon');
    
    if (!toggleBtn || !themeIcon) return;
    
    // Load saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        themeIcon.innerHTML = '<i class="fa-solid fa-sun"></i>';
    }
    
    // Toggle theme on click
    toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        themeIcon.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
}

// ==========================================
// Scroll to Top Button
// ==========================================

function initScrollToTop() {
    const scrollBtn = document.getElementById('scroll-to-top');
    if (!scrollBtn) return;

    window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
            scrollBtn.classList.add('visible');
        } else {
            scrollBtn.classList.remove('visible');
        }
    });

    scrollBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
}

// ==========================================
// Table of Contents Generator
// ==========================================

function generateTableOfContents() {
    const articleBody = document.querySelector('.article-detail-body');
    const tocList = document.getElementById('toc-list');
    const tocContainer = document.getElementById('article-toc');
    
    if (!articleBody || !tocList || !tocContainer) return;
    
    // Clear existing TOC
    tocList.innerHTML = '';
    
    // Find all headings in article content
    const headings = articleBody.querySelectorAll('h1, h2, h3');
    
    if (headings.length === 0) {
        tocContainer.classList.add('empty');
        return;
    }
    
    tocContainer.classList.remove('empty');
    
    headings.forEach((heading, index) => {
        // Create unique ID for the heading if it doesn't have one
        if (!heading.id) {
            heading.id = `heading-${index}`;
        }
        
        // Create TOC item
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${heading.id}`;
        a.textContent = heading.textContent;
        a.classList.add(`toc-${heading.tagName.toLowerCase()}`);
        
        // Smooth scroll on click
        a.addEventListener('click', (e) => {
            e.preventDefault();
            heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
        
        li.appendChild(a);
        tocList.appendChild(li);
    });
}

// Export new functions
window.removeAttachment = removeAttachment;
window.downloadAttachment = downloadAttachment;

function downloadAttachment(id) {
    const attachment = currentAttachments.find(a => a.id === id);
    if (!attachment) return;
    
    const href = attachment.url || attachment.data;
    if (!href) return;
    const link = document.createElement('a');
    link.href = href;
    link.download = attachment.name;
    link.target = '_blank';
    link.click();
}
